<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.demo.bbs.dao.BbsDao">

	<!-- 글 목록 조회 -->
	<select id="getBbsSearchPageList" parameterType="com.demo.bbs.dto.param.BbsListParam"
		resultType="com.demo.bbs.domain.Bbs">
		SELECT seq
			  ,id
			  ,ref
			  ,step
			  ,depth
			  ,title
			  ,content
			  ,created_at createdAt
			  ,del
			  ,read_count readCount
		FROM
					(SELECT 
							row_number() OVER(ORDER BY ref DESC, step ASC) AS rnum
							,seq
							,id
							,ref
							,step
							,depth
							,title
							,content
							,created_at
							,del
							,read_count
					FROM bbs
					<if test="choice != null and choice != '' and search != null and search != '' ">
						<if test="choice == 'title'">
							WHERE title LIKE concat('%', #{search}, '%')
						</if>
						<if test="choice == 'content'">
							WHERE content LIKE concat('%', #{search}, '%')
						</if>
						<if test="choice == 'writer'">
							WHERE id=#{search}
						</if>
					</if>
					ORDER BY ref DESC, step ASC) a
		WHERE rnum BETWEEN ${pageStart} AND ${pageEnd}
	</select>

	<!-- 글 총 개수 조회 -->
	<select id="getBbsCount" parameterType="com.demo.bbs.dto.param.BbsCountParam" resultType="Integer">

		SELECT ifnull(count(*), 0)
		FROM bbs
		<if test="choice != null and choice != '' and search != null and search != '' ">
			<if test="choice == 'title'">
				WHERE title LIKE concat('%', #{search}, '%')
			</if>
			<if test="choice == 'content'">
				WHERE content LIKE concat('%', #{search}, '%')
			</if>
			<if test="choice == 'writer'">
				WHERE id=#{search}
			</if>
		</if>
	</select>
	
	<!-- 특정 게시글 조회 -->
	<select id="getBbs" parameterType="Integer" resultType="com.demo.bbs.domain.Bbs">
		SELECT 
				seq
				,id
				,ref
				,step
				,depth
				,title
				,content
				,created_at createdAt
				,del
				,read_count readCount
		FROM bbs
		WHERE seq=#{seq}
		ORDER BY ref DESC, step ASC
	</select>
	
	<!-- 게시글 작성 -->
	<insert id="createBbs" parameterType="com.demo.bbs.dto.param.CreateBbsParam" useGeneratedKeys="true" keyProperty="seq">
		INSERT bbs (id, ref, step, depth, title, content, created_at, del, read_count)
		VALUES ("admin", (SELECT ifnull(max(ref), 0)+1 from bbs b), 0, 0, #{title}, #{content}, NOW(), 0, 0)
	</insert>
	
	<!-- 게시글 수정 -->
	<update id="updateBbs" parameterType="com.demo.bbs.dto.param.UpdateBbsParam">
		UPDATE bbs
		SET title = #{title}, content = #{content}
		where seq = #{seq}
	</update>
	
	<!-- 게시글 삭제 -->
	<update id="deleteBbs" parameterType="Integer">
		UPDATE bbs
		SET del = 1
		where seq = #{seq}
	</update>

</mapper>